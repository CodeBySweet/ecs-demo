name: ECS Cluster and Application Deployment

on:
  workflow_dispatch:
    inputs:
      action:
        description: "Choose 'apply' to create resources or 'destroy' to tear them down."
        required: true
        default: "apply"
        type: choice
        options:
          - apply
          - destroy

env:
  AWS_REGION: us-east-1  # AWS region for deployment
  IMAGE_TAG: latest      # Docker image tag
  ECR_REPOSITORY: my-app-repo # Must match your Terraform ECR repository name

permissions:
  id-token: write   # Required for OIDC authentication
  contents: read    # Required for actions/checkout

jobs:
  deploy-or-destroy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the code
      - name: Checkout code
        uses: actions/checkout@v3

      # Step 2: Configure AWS credentials via OIDC
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: arn:aws:iam::626635421987:role/GitHubActionsRole
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-Deployment

      # Step 3: Set up Terraform
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.7
          terraform_wrapper: false

      # Step 4: Initialize Terraform
      - name: Terraform Init
        run: terraform init

      # Step 5: Terraform Plan (for apply actions)
      - name: Terraform Plan
        if: github.event.inputs.action == 'apply'
        run: terraform plan

      # Step 6: Apply or Destroy Terraform configuration
      - name: Terraform Apply or Destroy
        run: |
          if [ "${{ github.event.inputs.action }}" == "apply" ]; then
            echo "Applying Terraform configuration..."
            terraform apply -auto-approve
          elif [ "${{ github.event.inputs.action }}" == "destroy" ]; then
            echo "Destroying Terraform configuration..."
            terraform destroy -auto-approve
          else
            echo "❌ Invalid action specified. Use 'apply' or 'destroy'."
            exit 1
          fi

      # Step 7: Skip Docker steps if action is 'destroy'
      - name: Check if action is 'apply'
        id: check-action
        run: |
          if [ "${{ github.event.inputs.action }}" == "apply" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

      # Step 8: Get Terraform outputs (only if action is 'apply')
      - name: Get Terraform Outputs
        if: steps.check-action.outputs.should_run == 'true'
        id: terraform-outputs
        run: |
          echo "ECR_REPOSITORY_URL=$(terraform output -raw ecr_repository_url)" >> $GITHUB_ENV
          echo "ECS_CLUSTER_NAME=$(terraform output -raw ecs_cluster_name)" >> $GITHUB_ENV
          echo "ECS_SERVICE_NAME=$(terraform output -raw ecs_service_name)" >> $GITHUB_ENV

      # Step 9: Install dependencies (only if action is 'apply')
      - name: Install dependencies
        if: steps.check-action.outputs.should_run == 'true'
        run: |
          echo "Installing dependencies..."
          pip install -r app/requirements.txt

      # Step 10: Install Docker and ECR Credential Helper (only if action is 'apply')
      - name: Install Docker and ECR Credential Helper
        if: steps.check-action.outputs.should_run == 'true'
        run: |
          echo "Installing Docker..."
          sudo apt-get update
          sudo apt-get install -y docker.io
          sudo systemctl start docker
          sudo systemctl enable docker

          echo "Installing AWS ECR Credential Helper..."
          curl -Lo /usr/local/bin/docker-credential-ecr-login \
            https://amazon-ecr-credential-helper-releases.s3.us-east-2.amazonaws.com/latest/linux-amd64/docker-credential-ecr-login
          chmod +x /usr/local/bin/docker-credential-ecr-login
          mkdir -p ~/.docker
          echo '{"credsStore":"ecr-login"}' > ~/.docker/config.json

      # Step 11: Log in to Amazon ECR (only if action is 'apply')
      - name: Log in to Amazon ECR
        if: steps.check-action.outputs.should_run == 'true'
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      # Step 12: Build, tag, and push Docker image to Amazon ECR (only if action is 'apply')
      - name: Build, tag, and push Docker image to Amazon ECR
        if: steps.check-action.outputs.should_run == 'true'
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
        run: |
          echo "Building Docker image..."
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -f app/Dockerfile .
          echo "Pushing Docker image to ECR..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

      # Step 13: Check ECR image scan findings (only if action is 'apply')
      - name: Check ECR image scan findings
        if: steps.check-action.outputs.should_run == 'true'
        run: |
          echo "Waiting for scan completion..."
          aws ecr wait image-scan-complete \
            --repository-name $ECR_REPOSITORY \
            --image-id imageTag=$IMAGE_TAG

          echo "Checking scan findings..."
          FINDING_SEVERITIES=$(aws ecr describe-image-scan-findings \
            --repository-name $ECR_REPOSITORY \
            --image-id imageTag=$IMAGE_TAG \
            --query 'imageScanFindings.findingSeverityCounts' \
            --output json)

          echo "Findings: $FINDING_SEVERITIES"
          
          CRITICAL_COUNT=$(echo $FINDING_SEVERITIES | jq -r '.CRITICAL // 0')
          if [ $CRITICAL_COUNT -gt 0 ]; then
            echo "❌ Critical vulnerabilities found"
            exit 1
          fi

      # Step 14: Force new ECS deployment (only if action is 'apply')
      - name: Force new ECS deployment
        if: steps.check-action.outputs.should_run == 'true'
        run: |
          echo "Updating ECS Service..."
          aws ecs update-service \
            --cluster $ECS_CLUSTER_NAME \
            --service $ECS_SERVICE_NAME \
            --force-new-deployment \
            --region $AWS_REGION
          echo "✅ ECS Service updated successfully."